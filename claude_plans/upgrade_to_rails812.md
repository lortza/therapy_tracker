Plan: Upgrade Rails from 8.0.0 to 8.1.2

 Objective

 Upgrade the Therapy Tracker Rails application from version 8.0.0 to 8.1.2, ensuring all tests pass and the application continues to function correctly with no regressions.

 Current State Summary

 Rails Version: 8.0.0
 Ruby Version: 3.3.6 (compatible with Rails 8.1.2)
 Database: PostgreSQL with pg gem 1.6.3
 Key Dependencies:
 - Devise 5.0.0 (Rails 7+ compatible)
 - Hotwire stack (turbo-rails, stimulus-rails)
 - Solid suite (solid_cache, solid_queue, solid_cable)
 - Bootstrap 4.1.3 (with dartsass-rails)
 - Draper 4.0.6
 - RSpec 8.0

 Configuration: Uses config.load_defaults 8.0 with Rails 8 autoloading

 ---
 Rails 8.1.2 Changes Review

 Based on https://guides.rubyonrails.org/8_1_release_notes.html, the upgrade from 8.0 to 8.1 is a minor version bump and should be straightforward.

 Major New Features (optional to adopt)

 - Active Job Continuations for long-running jobs
 - Structured Event Reporting (Rails.event.notify)
 - Local CI with config/ci.rb and bin/ci
 - Markdown rendering support
 - Deprecated associations support

 Breaking Changes That May Affect This App

 1. Parameter parsing: Leading brackets "[foo]=bar" now parse as { "[foo]" => "bar" } (app doesn't appear to use this pattern)
 2. Semicolon separator removal: Only & is supported in query strings (app doesn't appear to use ;)
 3. Removed deprecated Azure storage: App doesn't use Azure storage
 4. Removed deprecated SuckerPunch adapter: App doesn't use SuckerPunch

 Deprecations to Monitor (won't break immediately)

 - Order-dependent finder methods (#first without explicit ordering) - Check RSpec tests
 - ActiveRecord::Base.signed_id_verifier_secret - App doesn't appear to use this
 - WITH, WITH RECURSIVE, DISTINCT with update_all - Audit queries
 - Built-in Sidekiq adapter deprecated (gem provides it) - App uses Solid Queue, not Sidekiq

 Gems That Need Compatibility Check

 - ✅ Devise 5.0.0: Already Rails 7+ compatible, should work with 8.1
 - ✅ Draper 4.0.6: Should be compatible
 - ✅ Solid suite: Designed for Rails 8
 - ✅ Hotwire components: Actively maintained for Rails 8
 - ⚠️ Bootstrap 4.1.3: Old version but shouldn't break with Rails upgrade
 - ⚠️ Will-paginate 4.0.1: Should be compatible but needs testing

 ---
 Implementation Steps

 1. Pre-Upgrade Verification

 A. Ensure test suite passes on Rails 8.0.0
 bundle exec rspec
 If tests fail, fix them before upgrading.

 B. Check for existing deprecation warnings
 RAILS_ENV=development rails s
 # Visit key pages and check logs for deprecations

 C. Commit current state
 git add .
 git commit -m "Pre-Rails 8.1.2 upgrade checkpoint"

 ---
 2. Update Gemfile

 File: Gemfile

 Change Rails version from 8.0.0 to 8.1.2:

 # Before
 gem "rails", "8.0.0"

 # After
 gem "rails", "~> 8.1.2"

 Rationale: Using ~> 8.1.2 allows patch updates (8.1.3, 8.1.4, etc.) but not minor version jumps (8.2.x).

 ---
 3. Update Bundle

 bundle update rails

 This will update Rails and its dependencies:
 - All action* and active* gems (8.0.0 → 8.1.2)
 - railties (8.0.0 → 8.1.2)
 - Related dependencies as needed

 Expected Gemfile.lock changes:
 - 11 core Rails gems: 8.0.0 → 8.1.2
 - Possible updates to dependencies (zeitwerk, nokogiri, etc.)

 ---
 4. Run Rails Update Task

 rails app:update

 Purpose: Generates new configuration files and updates existing ones for Rails 8.1.

 Expected prompts:
 - Conflicts in configuration files (especially config/application.rb)
 - New initializer: config/initializers/new_framework_defaults_8_1.rb

 Action plan:
 - Review each conflict carefully
 - Keep custom configuration (Sentry, Devise, custom settings)
 - Accept new Rails 8.1 defaults where appropriate

 Key file to review: config/application.rb
 - Current: config.load_defaults 8.0
 - Decision: Update to config.load_defaults 8.1 OR use incremental approach with new_framework_defaults_8_1.rb

 ---
 5. Update Load Defaults Configuration

 Option A: Direct update (recommended for minor upgrades)

 File: config/application.rb

 # Change
 config.load_defaults 8.0

 # To
 config.load_defaults 8.1

 Option B: Incremental approach

 Keep config.load_defaults 8.0 and enable new features one-by-one in config/initializers/new_framework_defaults_8_1.rb (will be generated by rails app:update).

 Recommendation: Use Option A since the app is already on Rails 8.0 and the jump to 8.1 is small.

 ---
 6. Review and Test Core Functionality

 Run full test suite:

 bundle exec rspec

 Expected outcomes:
 - ✅ All tests pass (best case)
 - ⚠️ Deprecation warnings (note them but don't break)
 - ❌ Test failures (need investigation)

 Common issues to watch for:
 1. Finder method warnings: Check for Model.first without .order()
 2. Query method deprecations: WITH, DISTINCT with update_all
 3. Devise compatibility: Check authentication flows
 4. Draper compatibility: Check decorator usage
 5. Will-paginate: Check pagination in views

 ---
 7. Manual Testing Checklist

 Test critical user flows in development:

 Authentication (Devise):
 - User sign-in at /users/sign_in
 - User registration (if enabled) at /users/sign_up
 - Edit user settings at /users/edit
 - Password reset flow
 - Logout functionality

 Core Features:
 - Homepage loads correctly
 - Logs index page (/logs) with pagination
 - Create pain log (/pain_logs/new)
 - Create exercise log (/exercise_logs/new)
 - Rep counter modal functionality
 - SLIT timer functionality (if enabled)
 - PT session logs (if enabled)
 - Search functionality
 - Charts/reports render correctly

 Asset Pipeline:
 - CSS loads correctly (Bootstrap + custom styles)
 - JavaScript works (Stimulus controllers, Turbo)
 - No console errors in browser DevTools

 Background Jobs:
 - Solid Queue processes jobs (if any)

 ---
 8. Address Deprecation Warnings

 After tests pass, review logs for deprecation warnings:

 # In development
 tail -f log/development.log | grep DEPRECATION

 # In tests
 bundle exec rspec 2>&1 | grep DEPRECATION

 Common deprecations to address:

 A. Order-dependent finders
 # Deprecated
 User.first

 # Fix
 User.order(:created_at).first

 B. Update queries with WITH/DISTINCT
 # Check for usage in app/models/**/*.rb
 grep -r "update_all" app/models/

 C. Association deprecations
 - If any associations are marked as deprecated in gems, note them for future updates

 ---
 9. Update CI Configuration (Optional)

 Rails 8.1 introduces config/ci.rb and bin/ci. This is optional but recommended for local testing.

 Create: config/ci.rb (if desired)

 # Define CI workflow
 test "models" do
   run "bundle exec rspec spec/models"
 end

 test "controllers" do
   run "bundle exec rspec spec/controllers"
 end

 test "features" do
   run "bundle exec rspec spec/features"
 end

 Usage:
 bin/ci  # Runs all defined tests

 Decision point: Do you want to adopt this feature? (Not required for successful upgrade)

 ---
 10. Update CLAUDE.md Documentation

 File: CLAUDE.md

 Update the "Key Stack" section:

 # Before
 - Rails 8.0.0

 # After
 - Rails 8.1.2

 Update "Current Projects" section to reflect completed upgrade:

 ### Rails Upgrade Status
 - ✅ Rails 8.0 → 8.1.2 upgrade complete (2026-02-03)
 - Next: Monitor for Rails 8.2 release

 ---
 Critical Files to Review After Upgrade

 1. config/application.rb - Load defaults updated to 8.1
 2. config/initializers/new_framework_defaults_8_1.rb - New framework defaults (if using incremental approach)
 3. Gemfile.lock - Verify all gems updated correctly
 4. spec/ - All test files (watch for failures or deprecations)
 5. app/models/ - Check for order-dependent finders
 6. app/controllers/ - Check for deprecated patterns

 ---
 Rollback Plan

 If critical issues arise:

 Quick Rollback

 git checkout Gemfile Gemfile.lock
 bundle install
 git checkout config/application.rb
 rails restart

 Full Rollback

 git reset --hard HEAD~1  # If upgrade was single commit
 # Or
 git revert <commit-sha>  # If pushed to remote

 ---
 Verification Steps

 1. Automated Tests

 bundle exec rspec
 bundle exec standardrb  # Ruby linting

 2. Development Server

 bin/dev
 # Visit http://localhost:3000
 # Test key user flows listed in section 7

 3. Production-like Test

 RAILS_ENV=production rails assets:precompile
 RAILS_ENV=production rails db:migrate:status
 RAILS_ENV=production rails runner "puts Rails.version"

 4. Check for Deprecation Warnings

 # Run tests and scan for deprecations
 bundle exec rspec 2>&1 | grep -i deprecat

 # Run server and check logs
 tail -f log/development.log | grep -i deprecat

 ---
 Expected Outcomes

 ✅ Success Criteria:
 - All RSpec tests pass
 - No new errors in development logs
 - All key user flows work correctly
 - Devise authentication works
 - Hotwire (Turbo/Stimulus) functionality intact
 - Asset pipeline compiles correctly
 - Pagination works
 - Chartkick charts render

 ⚠️ Acceptable Warnings:
 - Deprecation warnings (note them for future work)
 - Sass @import warnings (pre-existing, from Bootstrap)

 ❌ Failure Indicators:
 - Test failures related to Rails core functionality
 - Authentication broken
 - Asset compilation failures
 - Database query errors

 ---
 Post-Upgrade Tasks (Future Work)

 These are NOT part of this upgrade but worth noting:

 1. Address deprecation warnings from Rails 8.1
 2. Bootstrap 4 → 5 upgrade (separate project)
 3. Sass @import → @use migration (separate project)
 4. Adopt Rails 8.1 new features (CI, event reporting, job continuations)
 5. Monitor for Rails 8.2 release

 ---
 Timeline Estimate

 - Pre-upgrade verification: 10 minutes
 - Gem update: 2-5 minutes
 - Rails app:update: 5-10 minutes (with conflict resolution)
 - Test suite run: 2-5 minutes
 - Manual testing: 10-15 minutes
 - Documentation update: 2 minutes

 Total: 30-45 minutes for a smooth upgrade

 ---
 Risk Assessment

 Overall Risk: LOW

 Why low risk:
 - Minor version upgrade (8.0 → 8.1)
 - App already uses Rails 8 conventions
 - Strong test coverage
 - Ruby 3.3.6 is compatible
 - Key gems (Devise, Draper, Hotwire) are Rails 8 compatible
 - No custom Rails engines or complex Railtie configurations

 Potential issues:
 - Order-dependent finder deprecations (fixable)
 - Gem compatibility (unlikely but possible)
 - Custom query methods with update_all (unlikely in this app)

 Mitigation:
 - Full test suite before and after
 - Git checkpoint before starting
 - Clear rollback plan
 - Manual testing of critical flows

 ---
 References

 - https://guides.rubyonrails.org/8_1_release_notes.html
 - https://guides.rubyonrails.org/upgrading_ruby_on_rails.html
 - https://rubyonrails.org/2026/1/22/rails-version-8-1-2-has-been-released
 - https://github.com/rails/rails/releases

 ---
 Notes

 - This plan assumes the app is in a working state on Rails 8.0.0
 - Test coverage should be run before starting
 - The upgrade is low-risk but should be done with care
 - Deprecation warnings are expected and should be addressed in future work
 - Bootstrap 4.1.3 is old but won't block this upgrade (separate modernization needed)